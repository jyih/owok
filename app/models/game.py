from email.policy import default
from .db import db
from datetime import datetime
from sqlalchemy.dialects.postgresql import JSONB


def default_turn(context):
    return context.get_current_parameters()["player_one_id"]


def default_board(context):
    moves = context.get_current_parameters()['moves'].split(',')
    board = {
        "0000": {"coord": "0000", "piece": ""},
        "0001": {"coord": "0001", "piece": ""},
        "0002": {"coord": "0002", "piece": ""},
        "0003": {"coord": "0003", "piece": ""},
        "0004": {"coord": "0004", "piece": ""},
        "0005": {"coord": "0005", "piece": ""},
        "0006": {"coord": "0006", "piece": ""},
        "0007": {"coord": "0007", "piece": ""},
        "0008": {"coord": "0008", "piece": ""},
        "0009": {"coord": "0009", "piece": ""},
        "0010": {"coord": "0010", "piece": ""},
        "0011": {"coord": "0011", "piece": ""},
        "0012": {"coord": "0012", "piece": ""},
        "0013": {"coord": "0013", "piece": ""},
        "0014": {"coord": "0014", "piece": ""},
        "0100": {"coord": "0100", "piece": ""},
        "0101": {"coord": "0101", "piece": ""},
        "0102": {"coord": "0102", "piece": ""},
        "0103": {"coord": "0103", "piece": ""},
        "0104": {"coord": "0104", "piece": ""},
        "0105": {"coord": "0105", "piece": ""},
        "0106": {"coord": "0106", "piece": ""},
        "0107": {"coord": "0107", "piece": ""},
        "0108": {"coord": "0108", "piece": ""},
        "0109": {"coord": "0109", "piece": ""},
        "0110": {"coord": "0110", "piece": ""},
        "0111": {"coord": "0111", "piece": ""},
        "0112": {"coord": "0112", "piece": ""},
        "0113": {"coord": "0113", "piece": ""},
        "0114": {"coord": "0114", "piece": ""},
        "0200": {"coord": "0200", "piece": ""},
        "0201": {"coord": "0201", "piece": ""},
        "0202": {"coord": "0202", "piece": ""},
        "0203": {"coord": "0203", "piece": ""},
        "0204": {"coord": "0204", "piece": ""},
        "0205": {"coord": "0205", "piece": ""},
        "0206": {"coord": "0206", "piece": ""},
        "0207": {"coord": "0207", "piece": ""},
        "0208": {"coord": "0208", "piece": ""},
        "0209": {"coord": "0209", "piece": ""},
        "0210": {"coord": "0210", "piece": ""},
        "0211": {"coord": "0211", "piece": ""},
        "0212": {"coord": "0212", "piece": ""},
        "0213": {"coord": "0213", "piece": ""},
        "0214": {"coord": "0214", "piece": ""},
        "0300": {"coord": "0300", "piece": ""},
        "0301": {"coord": "0301", "piece": ""},
        "0302": {"coord": "0302", "piece": ""},
        "0303": {"coord": "0303", "piece": ""},
        "0304": {"coord": "0304", "piece": ""},
        "0305": {"coord": "0305", "piece": ""},
        "0306": {"coord": "0306", "piece": ""},
        "0307": {"coord": "0307", "piece": ""},
        "0308": {"coord": "0308", "piece": ""},
        "0309": {"coord": "0309", "piece": ""},
        "0310": {"coord": "0310", "piece": ""},
        "0311": {"coord": "0311", "piece": ""},
        "0312": {"coord": "0312", "piece": ""},
        "0313": {"coord": "0313", "piece": ""},
        "0314": {"coord": "0314", "piece": ""},
        "0400": {"coord": "0400", "piece": ""},
        "0401": {"coord": "0401", "piece": ""},
        "0402": {"coord": "0402", "piece": ""},
        "0403": {"coord": "0403", "piece": ""},
        "0404": {"coord": "0404", "piece": ""},
        "0405": {"coord": "0405", "piece": ""},
        "0406": {"coord": "0406", "piece": ""},
        "0407": {"coord": "0407", "piece": ""},
        "0408": {"coord": "0408", "piece": ""},
        "0409": {"coord": "0409", "piece": ""},
        "0410": {"coord": "0410", "piece": ""},
        "0411": {"coord": "0411", "piece": ""},
        "0412": {"coord": "0412", "piece": ""},
        "0413": {"coord": "0413", "piece": ""},
        "0414": {"coord": "0414", "piece": ""},
        "0500": {"coord": "0500", "piece": ""},
        "0501": {"coord": "0501", "piece": ""},
        "0502": {"coord": "0502", "piece": ""},
        "0503": {"coord": "0503", "piece": ""},
        "0504": {"coord": "0504", "piece": ""},
        "0505": {"coord": "0505", "piece": ""},
        "0506": {"coord": "0506", "piece": ""},
        "0507": {"coord": "0507", "piece": ""},
        "0508": {"coord": "0508", "piece": ""},
        "0509": {"coord": "0509", "piece": ""},
        "0510": {"coord": "0510", "piece": ""},
        "0511": {"coord": "0511", "piece": ""},
        "0512": {"coord": "0512", "piece": ""},
        "0513": {"coord": "0513", "piece": ""},
        "0514": {"coord": "0514", "piece": ""},
        "0600": {"coord": "0600", "piece": ""},
        "0601": {"coord": "0601", "piece": ""},
        "0602": {"coord": "0602", "piece": ""},
        "0603": {"coord": "0603", "piece": ""},
        "0604": {"coord": "0604", "piece": ""},
        "0605": {"coord": "0605", "piece": ""},
        "0606": {"coord": "0606", "piece": ""},
        "0607": {"coord": "0607", "piece": ""},
        "0608": {"coord": "0608", "piece": ""},
        "0609": {"coord": "0609", "piece": ""},
        "0610": {"coord": "0610", "piece": ""},
        "0611": {"coord": "0611", "piece": ""},
        "0612": {"coord": "0612", "piece": ""},
        "0613": {"coord": "0613", "piece": ""},
        "0614": {"coord": "0614", "piece": ""},
        "0700": {"coord": "0700", "piece": ""},
        "0701": {"coord": "0701", "piece": ""},
        "0702": {"coord": "0702", "piece": ""},
        "0703": {"coord": "0703", "piece": ""},
        "0704": {"coord": "0704", "piece": ""},
        "0705": {"coord": "0705", "piece": ""},
        "0706": {"coord": "0706", "piece": ""},
        "0707": {"coord": "0707", "piece": ""},
        "0708": {"coord": "0708", "piece": ""},
        "0709": {"coord": "0709", "piece": ""},
        "0710": {"coord": "0710", "piece": ""},
        "0711": {"coord": "0711", "piece": ""},
        "0712": {"coord": "0712", "piece": ""},
        "0713": {"coord": "0713", "piece": ""},
        "0714": {"coord": "0714", "piece": ""},
        "0800": {"coord": "0800", "piece": ""},
        "0801": {"coord": "0801", "piece": ""},
        "0802": {"coord": "0802", "piece": ""},
        "0803": {"coord": "0803", "piece": ""},
        "0804": {"coord": "0804", "piece": ""},
        "0805": {"coord": "0805", "piece": ""},
        "0806": {"coord": "0806", "piece": ""},
        "0807": {"coord": "0807", "piece": ""},
        "0808": {"coord": "0808", "piece": ""},
        "0809": {"coord": "0809", "piece": ""},
        "0810": {"coord": "0810", "piece": ""},
        "0811": {"coord": "0811", "piece": ""},
        "0812": {"coord": "0812", "piece": ""},
        "0813": {"coord": "0813", "piece": ""},
        "0814": {"coord": "0814", "piece": ""},
        "0900": {"coord": "0900", "piece": ""},
        "0901": {"coord": "0901", "piece": ""},
        "0902": {"coord": "0902", "piece": ""},
        "0903": {"coord": "0903", "piece": ""},
        "0904": {"coord": "0904", "piece": ""},
        "0905": {"coord": "0905", "piece": ""},
        "0906": {"coord": "0906", "piece": ""},
        "0907": {"coord": "0907", "piece": ""},
        "0908": {"coord": "0908", "piece": ""},
        "0909": {"coord": "0909", "piece": ""},
        "0910": {"coord": "0910", "piece": ""},
        "0911": {"coord": "0911", "piece": ""},
        "0912": {"coord": "0912", "piece": ""},
        "0913": {"coord": "0913", "piece": ""},
        "0914": {"coord": "0914", "piece": ""},
        "1000": {"coord": "1000", "piece": ""},
        "1001": {"coord": "1001", "piece": ""},
        "1002": {"coord": "1002", "piece": ""},
        "1003": {"coord": "1003", "piece": ""},
        "1004": {"coord": "1004", "piece": ""},
        "1005": {"coord": "1005", "piece": ""},
        "1006": {"coord": "1006", "piece": ""},
        "1007": {"coord": "1007", "piece": ""},
        "1008": {"coord": "1008", "piece": ""},
        "1009": {"coord": "1009", "piece": ""},
        "1010": {"coord": "1010", "piece": ""},
        "1011": {"coord": "1011", "piece": ""},
        "1012": {"coord": "1012", "piece": ""},
        "1013": {"coord": "1013", "piece": ""},
        "1014": {"coord": "1014", "piece": ""},
        "1100": {"coord": "1100", "piece": ""},
        "1101": {"coord": "1101", "piece": ""},
        "1102": {"coord": "1102", "piece": ""},
        "1103": {"coord": "1103", "piece": ""},
        "1104": {"coord": "1104", "piece": ""},
        "1105": {"coord": "1105", "piece": ""},
        "1106": {"coord": "1106", "piece": ""},
        "1107": {"coord": "1107", "piece": ""},
        "1108": {"coord": "1108", "piece": ""},
        "1109": {"coord": "1109", "piece": ""},
        "1110": {"coord": "1110", "piece": ""},
        "1111": {"coord": "1111", "piece": ""},
        "1112": {"coord": "1112", "piece": ""},
        "1113": {"coord": "1113", "piece": ""},
        "1114": {"coord": "1114", "piece": ""},
        "1200": {"coord": "1200", "piece": ""},
        "1201": {"coord": "1201", "piece": ""},
        "1202": {"coord": "1202", "piece": ""},
        "1203": {"coord": "1203", "piece": ""},
        "1204": {"coord": "1204", "piece": ""},
        "1205": {"coord": "1205", "piece": ""},
        "1206": {"coord": "1206", "piece": ""},
        "1207": {"coord": "1207", "piece": ""},
        "1208": {"coord": "1208", "piece": ""},
        "1209": {"coord": "1209", "piece": ""},
        "1210": {"coord": "1210", "piece": ""},
        "1211": {"coord": "1211", "piece": ""},
        "1212": {"coord": "1212", "piece": ""},
        "1213": {"coord": "1213", "piece": ""},
        "1214": {"coord": "1214", "piece": ""},
        "1300": {"coord": "1300", "piece": ""},
        "1301": {"coord": "1301", "piece": ""},
        "1302": {"coord": "1302", "piece": ""},
        "1303": {"coord": "1303", "piece": ""},
        "1304": {"coord": "1304", "piece": ""},
        "1305": {"coord": "1305", "piece": ""},
        "1306": {"coord": "1306", "piece": ""},
        "1307": {"coord": "1307", "piece": ""},
        "1308": {"coord": "1308", "piece": ""},
        "1309": {"coord": "1309", "piece": ""},
        "1310": {"coord": "1310", "piece": ""},
        "1311": {"coord": "1311", "piece": ""},
        "1312": {"coord": "1312", "piece": ""},
        "1313": {"coord": "1313", "piece": ""},
        "1314": {"coord": "1314", "piece": ""},
        "1400": {"coord": "1400", "piece": ""},
        "1401": {"coord": "1401", "piece": ""},
        "1402": {"coord": "1402", "piece": ""},
        "1403": {"coord": "1403", "piece": ""},
        "1404": {"coord": "1404", "piece": ""},
        "1405": {"coord": "1405", "piece": ""},
        "1406": {"coord": "1406", "piece": ""},
        "1407": {"coord": "1407", "piece": ""},
        "1408": {"coord": "1408", "piece": ""},
        "1409": {"coord": "1409", "piece": ""},
        "1410": {"coord": "1410", "piece": ""},
        "1411": {"coord": "1411", "piece": ""},
        "1412": {"coord": "1412", "piece": ""},
        "1413": {"coord": "1413", "piece": ""},
        "1414": {"coord": "1414", "piece": ""},
    }
    for idx, move in enumerate(moves):
        board[move]["piece"] = idx % 2
    return board


class Game(db.Model):
    __tablename__ = "games"

    id = db.Column(db.Integer, primary_key=True)
    player_one_id = db.Column(db.Integer, db.ForeignKey("users.id"), nullable=False)
    player_two_id = db.Column(db.Integer, db.ForeignKey("users.id"), nullable=False)
    winner_id = db.Column(db.Integer, nullable=True, default=None)
    moves = db.Column(db.String(12000), nullable=False, default="")
    board = db.Column(JSONB, nullable=True, default=default_board)
    turn = db.Column(db.Integer, default=0)

    is_private_one = db.Column(db.Boolean, nullable=False, default=False)
    is_private_two = db.Column(db.Boolean, nullable=False, default=False)
    created_at = db.Column(db.DateTime(), default=datetime.utcnow, nullable=False)
    updated_at = db.Column(
        db.DateTime(), default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False
    )

    player_one = db.relationship(
        "User", foreign_keys=[player_one_id], back_populates="games_player_one"
    )

    player_two = db.relationship(
        "User", foreign_keys=[player_two_id], back_populates="games_player_two"
    )

    comments = db.relationship(
        "Comment",
        back_populates="game",
        cascade="all, delete",
    )

    def to_dict(self):
        return {
            "id": self.id,
            "player_one_id": self.player_one_id,
            "player_two_id": self.player_two_id,
            "winner_id": self.winner_id,
            "moves": self.moves,
            "board": self.board,
            "turn": self.turn,
            "is_private_one": self.is_private_one,
            "is_private_two": self.is_private_two,
            "created_at": self.created_at,
            "updated_at": self.updated_at,
            "user_player_one": self.player_one.to_dict(),
            "user_player_two": self.player_two.to_dict(),
            "comments": {c.to_dict()["id"]: c.to_dict() for c in self.comments},
        }

    def get_players(self):
        return (self.player_one_id, self.player_two_id)
